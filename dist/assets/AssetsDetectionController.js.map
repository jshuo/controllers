{"version":3,"file":"AssetsDetectionController.js","sourceRoot":"","sources":["../../src/assets/AssetsDetectionController.ts"],"names":[],"mappings":"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","sourcesContent":["import { BaseController, BaseConfig, BaseState } from '../BaseController';\nimport type { NetworkState, NetworkType } from '../network/NetworkController';\nimport type { PreferencesState } from '../user/PreferencesController';\nimport { safelyExecute, timeoutFetch, toChecksumHexAddress } from '../util';\nimport { MAINNET } from '../constants';\nimport type {\n  CollectiblesController,\n  CollectiblesState,\n  CollectibleMetadata,\n} from './CollectiblesController';\nimport type { TokensController, TokensState } from './TokensController';\nimport type { AssetsContractController } from './AssetsContractController';\nimport { Token } from './TokenRatesController';\nimport { TokenListState } from './TokenListController';\n\nconst DEFAULT_INTERVAL = 180000;\n\n/**\n * @type ApiCollectible\n *\n * Collectible object coming from OpenSea api\n * @property token_id - The collectible identifier\n * @property num_sales - Number of sales\n * @property background_color - The background color to be displayed with the item\n * @property image_url - URI of an image associated with this collectible\n * @property image_preview_url - URI of a smaller image associated with this collectible\n * @property image_thumbnail_url - URI of a thumbnail image associated with this collectible\n * @property image_original_url - URI of the original image associated with this collectible\n * @property animation_url - URI of a animation associated with this collectible\n * @property animation_original_url - URI of the original animation associated with this collectible\n * @property name - The collectible name\n * @property description - The collectible description\n * @property external_link - External link containing additional information\n * @property assetContract - The collectible contract information object\n * @property creator - The collectible owner information object\n * @property lastSale - When this item was last sold\n */\nexport interface ApiCollectible {\n  token_id: string;\n  num_sales: number | null;\n  background_color: string | null;\n  image_url: string | null;\n  image_preview_url: string | null;\n  image_thumbnail_url: string | null;\n  image_original_url: string | null;\n  animation_url: string | null;\n  animation_original_url: string | null;\n  name: string | null;\n  description: string | null;\n  external_link: string | null;\n  asset_contract: ApiCollectibleContract;\n  creator: ApiCollectibleCreator;\n  last_sale: ApiCollectibleLastSale | null;\n}\n\n/**\n * @type ApiCollectibleContract\n *\n * Collectible contract object coming from OpenSea api\n * @property address - Address of the collectible contract\n * @property asset_contract_type - The collectible type, it could be `semi-fungible` or `non-fungible`\n * @property created_date - Creation date\n * @property name - The collectible contract name\n * @property schema_name - The schema followed by the contract, it could be `ERC721` or `ERC1155`\n * @property symbol - The collectible contract symbol\n * @property total_supply - Total supply of collectibles\n * @property description - The collectible contract description\n * @property external_link - External link containing additional information\n * @property image_url - URI of an image associated with this collectible contract\n */\nexport interface ApiCollectibleContract {\n  address: string;\n  asset_contract_type: string | null;\n  created_date: string | null;\n  name: string | null;\n  schema_name: string | null;\n  symbol: string | null;\n  total_supply: string | null;\n  description: string | null;\n  external_link: string | null;\n  image_url: string | null;\n}\n\n/**\n * @type ApiCollectibleLastSale\n *\n * Collectible sale object coming from OpenSea api\n * @property event_timestamp - Object containing a `username`\n * @property total_price - URI of collectible image associated with this owner\n * @property transaction - Object containing transaction_hash and block_hash\n */\nexport interface ApiCollectibleLastSale {\n  event_timestamp: string;\n  total_price: string;\n  transaction: { transaction_hash: string; block_hash: string };\n}\n\n/**\n * @type ApiCollectibleCreator\n *\n * Collectible creator object coming from OpenSea api\n * @property user - Object containing a `username`\n * @property profile_img_url - URI of collectible image associated with this owner\n * @property address - The owner address\n */\nexport interface ApiCollectibleCreator {\n  user: { username: string };\n  profile_img_url: string;\n  address: string;\n}\n\n/**\n * @type AssetsConfig\n *\n * Assets controller configuration\n * @property interval - Polling interval used to fetch new token rates\n * @property networkType - Network type ID as per net_version\n * @property selectedAddress - Vault selected address\n * @property tokens - List of tokens associated with the active vault\n */\nexport interface AssetsDetectionConfig extends BaseConfig {\n  interval: number;\n  networkType: NetworkType;\n  selectedAddress: string;\n  tokens: Token[];\n}\n\n/**\n * Controller that passively polls on a set interval for assets auto detection\n */\nexport class AssetsDetectionController extends BaseController<\n  AssetsDetectionConfig,\n  BaseState\n> {\n  private handle?: NodeJS.Timer;\n\n  private getOwnerCollectiblesApi(address: string, offset: number) {\n    return `https://api.opensea.io/api/v1/assets?owner=${address}&offset=${offset}&limit=50`;\n  }\n\n  private async getOwnerCollectibles() {\n    const { selectedAddress } = this.config;\n    let response: Response;\n    let collectibles: any = [];\n    const openSeaApiKey = this.getOpenSeaApiKey();\n    try {\n      let offset = 0;\n      let pagingFinish = false;\n      /* istanbul ignore if */\n      do {\n        const api = this.getOwnerCollectiblesApi(selectedAddress, offset);\n        response = await timeoutFetch(\n          api,\n          openSeaApiKey ? { headers: { 'X-API-KEY': openSeaApiKey } } : {},\n          15000,\n        );\n        const collectiblesArray = await response.json();\n        collectiblesArray.assets?.length !== 0\n          ? (collectibles = [...collectibles, ...collectiblesArray.assets])\n          : (pagingFinish = true);\n        offset += 50;\n      } while (!pagingFinish);\n    } catch (e) {\n      /* istanbul ignore next */\n      return [];\n    }\n    return collectibles;\n  }\n\n  /**\n   * Name of this controller used during composition\n   */\n  name = 'AssetsDetectionController';\n\n  private getOpenSeaApiKey: () => string | undefined;\n\n  private getBalancesInSingleCall: AssetsContractController['getBalancesInSingleCall'];\n\n  private addTokens: TokensController['addTokens'];\n\n  private addCollectible: CollectiblesController['addCollectible'];\n\n  private getCollectiblesState: () => CollectiblesState;\n\n  private getTokensState: () => TokensState;\n\n  private getTokenListState: () => TokenListState;\n\n  /**\n   * Creates a AssetsDetectionController instance.\n   *\n   * @param options - The controller options.\n   * @param options.onCollectiblesStateChange - Allows subscribing to assets controller state changes.\n   * @param options.onTokensStateChange - Allows subscribing to tokens controller state changes.\n   * @param options.onPreferencesStateChange - Allows subscribing to preferences controller state changes.\n   * @param options.onNetworkStateChange - Allows subscribing to network controller state changes.\n   * @param options.getOpenSeaApiKey - Gets the OpenSea API key, if one is set.\n   * @param options.getBalancesInSingleCall - Gets the balances of a list of tokens for the given address.\n   * @param options.addTokens - Add a list of tokens.\n   * @param options.addCollectible - Add a collectible.\n   * @param options.getCollectiblesState - Gets the current state of the Assets controller.\n   * @param options.getTokenListState - Gets the current state of the TokenList controller.\n   * @param options.getTokensState - Gets the current state of the Tokens controller.\n   * @param config - Initial options used to configure this controller.\n   * @param state - Initial state to set on this controller.\n   */\n  constructor(\n    {\n      onTokensStateChange,\n      onPreferencesStateChange,\n      onNetworkStateChange,\n      getOpenSeaApiKey,\n      getBalancesInSingleCall,\n      addTokens,\n      addCollectible,\n      getCollectiblesState,\n      getTokenListState,\n      getTokensState,\n    }: {\n      onCollectiblesStateChange: (\n        listener: (collectiblesState: CollectiblesState) => void,\n      ) => void;\n      onTokensStateChange: (\n        listener: (tokensState: TokensState) => void,\n      ) => void;\n      onPreferencesStateChange: (\n        listener: (preferencesState: PreferencesState) => void,\n      ) => void;\n      onNetworkStateChange: (\n        listener: (networkState: NetworkState) => void,\n      ) => void;\n      getOpenSeaApiKey: () => string | undefined;\n      getBalancesInSingleCall: AssetsContractController['getBalancesInSingleCall'];\n      addTokens: TokensController['addTokens'];\n      addCollectible: CollectiblesController['addCollectible'];\n      getCollectiblesState: () => CollectiblesState;\n      getTokenListState: () => TokenListState;\n      getTokensState: () => TokensState;\n    },\n    config?: Partial<AssetsDetectionConfig>,\n    state?: Partial<BaseState>,\n  ) {\n    super(config, state);\n    this.defaultConfig = {\n      interval: DEFAULT_INTERVAL,\n      networkType: MAINNET,\n      selectedAddress: '',\n      tokens: [],\n    };\n    this.initialize();\n    this.getCollectiblesState = getCollectiblesState;\n    this.getTokensState = getTokensState;\n    this.getTokenListState = getTokenListState;\n    this.addTokens = addTokens;\n    onTokensStateChange(({ tokens }) => {\n      this.configure({ tokens });\n    });\n\n    onPreferencesStateChange(({ selectedAddress }) => {\n      const actualSelectedAddress = this.config.selectedAddress;\n      if (selectedAddress !== actualSelectedAddress) {\n        this.configure({ selectedAddress });\n        this.detectAssets();\n      }\n    });\n\n    onNetworkStateChange(({ provider }) => {\n      this.configure({ networkType: provider.type });\n    });\n    this.getOpenSeaApiKey = getOpenSeaApiKey;\n    this.getBalancesInSingleCall = getBalancesInSingleCall;\n    this.addCollectible = addCollectible;\n    this.poll();\n  }\n\n  /**\n   * Starts a new polling interval.\n   *\n   * @param interval - Polling interval used to auto detect assets.\n   */\n  async poll(interval?: number): Promise<void> {\n    interval && this.configure({ interval }, false, false);\n    this.handle && clearTimeout(this.handle);\n    await this.detectAssets();\n    this.handle = setTimeout(() => {\n      this.poll(this.config.interval);\n    }, this.config.interval);\n  }\n\n  /**\n   * Checks whether network is mainnet or not.\n   *\n   * @returns Whether current network is mainnet.\n   */\n  isMainnet() {\n    if (this.config.networkType !== MAINNET || this.disabled) {\n      return false;\n    }\n    return true;\n  }\n\n  /**\n   * Detect assets owned by current account on mainnet.\n   */\n  async detectAssets() {\n    /* istanbul ignore if */\n    if (!this.isMainnet()) {\n      return;\n    }\n    this.detectTokens();\n    this.detectCollectibles();\n  }\n\n  /**\n   * Triggers asset ERC20 token auto detection for each contract address in contract metadata on mainnet.\n   */\n  async detectTokens() {\n    /* istanbul ignore if */\n    if (!this.isMainnet()) {\n      return;\n    }\n    const tokensAddresses = this.config.tokens.map(\n      /* istanbul ignore next*/ (token) => token.address.toLowerCase(),\n    );\n    const { tokenList } = this.getTokenListState();\n    const tokensToDetect: string[] = [];\n    for (const address in tokenList) {\n      if (!tokensAddresses.includes(address)) {\n        tokensToDetect.push(address);\n      }\n    }\n    const sliceOfTokensToDetect = [];\n    sliceOfTokensToDetect[0] = tokensToDetect.slice(0, 1000);\n    sliceOfTokensToDetect[1] = tokensToDetect.slice(\n      1000,\n      tokensToDetect.length - 1,\n    );\n\n    const { selectedAddress } = this.config;\n    /* istanbul ignore else */\n    if (!selectedAddress) {\n      return;\n    }\n\n    for (const tokensSlice of sliceOfTokensToDetect) {\n      if (tokensSlice.length === 0) {\n        break;\n      }\n\n      await safelyExecute(async () => {\n        const balances = await this.getBalancesInSingleCall(\n          selectedAddress,\n          tokensSlice,\n        );\n        const tokensToAdd = [];\n        for (const tokenAddress in balances) {\n          let ignored;\n          /* istanbul ignore else */\n          const { ignoredTokens } = this.getTokensState();\n          if (ignoredTokens.length) {\n            ignored = ignoredTokens.find(\n              (ignoredTokenAddress) =>\n                ignoredTokenAddress === toChecksumHexAddress(tokenAddress),\n            );\n          }\n          const caseInsensitiveTokenKey =\n            Object.keys(tokenList).find(\n              (i) => i.toLowerCase() === tokenAddress.toLowerCase(),\n            ) || '';\n\n          if (ignored === undefined) {\n            tokensToAdd.push({\n              address: tokenAddress,\n              decimals: tokenList[caseInsensitiveTokenKey].decimals,\n              symbol: tokenList[caseInsensitiveTokenKey].symbol,\n            });\n          }\n        }\n\n        if (tokensToAdd.length) {\n          await this.addTokens(tokensToAdd);\n        }\n      });\n    }\n  }\n\n  /**\n   * Triggers asset ERC721 token auto detection on mainnet. Any newly detected collectibles are\n   * added.\n   */\n  async detectCollectibles() {\n    /* istanbul ignore if */\n    if (!this.isMainnet()) {\n      return;\n    }\n    const requestedSelectedAddress = this.config.selectedAddress;\n\n    /* istanbul ignore else */\n    if (!requestedSelectedAddress) {\n      return;\n    }\n\n    await safelyExecute(async () => {\n      const apiCollectibles = await this.getOwnerCollectibles();\n      const addCollectiblesPromises = apiCollectibles.map(\n        async (collectible: ApiCollectible) => {\n          const {\n            token_id,\n            num_sales,\n            background_color,\n            image_url,\n            image_preview_url,\n            image_thumbnail_url,\n            image_original_url,\n            animation_url,\n            animation_original_url,\n            name,\n            description,\n            external_link,\n            creator,\n            asset_contract: { address },\n            last_sale,\n          } = collectible;\n\n          let ignored;\n          /* istanbul ignore else */\n          const { ignoredCollectibles } = this.getCollectiblesState();\n          if (ignoredCollectibles.length) {\n            ignored = ignoredCollectibles.find((c) => {\n              /* istanbul ignore next */\n              return (\n                c.address === toChecksumHexAddress(address) &&\n                c.tokenId === Number(token_id)\n              );\n            });\n          }\n\n          /* istanbul ignore else */\n          if (\n            !ignored &&\n            requestedSelectedAddress === this.config.selectedAddress\n          ) {\n            /* istanbul ignore next */\n            const collectibleMetadata: CollectibleMetadata = Object.assign(\n              {},\n              { name },\n              creator && { creator },\n              description && { description },\n              image_url && { image: image_url },\n              num_sales && { numberOfSales: num_sales },\n              background_color && { backgroundColor: background_color },\n              image_preview_url && { imagePreview: image_preview_url },\n              image_thumbnail_url && { imageThumbnail: image_thumbnail_url },\n              image_original_url && { imageOriginal: image_original_url },\n              animation_url && { animation: animation_url },\n              animation_original_url && {\n                animationOriginal: animation_original_url,\n              },\n              external_link && { externalLink: external_link },\n              last_sale && { lastSale: last_sale },\n            );\n            await this.addCollectible(\n              address,\n              Number(token_id),\n              collectibleMetadata,\n              true,\n            );\n          }\n        },\n      );\n      await Promise.all(addCollectiblesPromises);\n    });\n  }\n}\n\nexport default AssetsDetectionController;\n"]}